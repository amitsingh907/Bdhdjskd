<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wraith Pro Predictor Elite</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* Base Variables - More premium, deeper tones */
        :root {
            --primary-dark: #1a202c; /* Dark charcoal/navy for deep backgrounds */
            --primary-accent: #ffb800; /* Rich gold/amber for accents */
            --secondary-text: #a0aec0; /* Lighter grey for secondary text */
            --light-bg: #f8f8f8; /* Very light grey for contrasting sections */
            --white: #ffffff;

            /* Component Colors */
            --card-bg: #2d3748; /* Slightly lighter dark for card backgrounds */
            --input-bg: #4a5568; /* Darker input fields */
            --border-color: #4a5568; /* Subtle border for elements */
            --shadow-strong: rgba(0, 0, 0, 0.4);
            --shadow-light: rgba(0, 0, 0, 0.2);

            /* Status Colors */
            --success-strong: #04b34b; /* Vibrant green */
            --danger-strong: #e53e3e; /* Strong red */
            --info-strong: #3182ce; /* Bright blue */
            --warning-strong: #f6ad55; /* Warm orange */

            /* Predictor Specific - More striking */
            --predictor-bg: linear-gradient(145deg, #1f2733, #0a0e14); /* Dark gradient background */
            --predictor-card-bg: #2a313b; /* Darker card for predictor */
            --predictor-border: #3b424f;
            --big-color: #e53e3e; /* Strong red for BIG */
            --small-color: #04b34b; /* Strong green for SMALL */
            --result-glow: drop-shadow(0 0 8px rgba(255, 184, 0, 0.6)); /* Glow for results */
        }

        /* General Body & Container Styling */
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--primary-dark);
            color: var(--secondary-text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column; /* Allow content to stack */
            padding-bottom: 80px; /* Space for fixed nav */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .container {
            width: 95%;
            max-width: 450px;
            padding: 30px;
            box-sizing: border-box;
            text-align: center;
        }

        /* Authentication Container */
        #auth-container {
            background-color: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-strong);
            border-top: 6px solid var(--primary-accent);
            display: block;
            margin-top: 50px; /* Push down slightly for better centering */
        }

        /* Main Application Container */
        #main-app-container {
            width: 95%;
            max-width: 700px; /* Larger max-width for more content */
            min-height: 85vh;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px var(--shadow-strong);
            border-top: 6px solid var(--success-strong);
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 25px; /* More space between sections */
            margin-top: 30px; /* Space from top */
        }

        h1, h2 {
            color: var(--primary-accent);
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 800;
            text-shadow: 0 0 5px rgba(255, 184, 0, 0.4);
            border-bottom: 2px solid rgba(255, 184, 0, 0.2);
            padding-bottom: 15px;
            letter-spacing: 1px;
        }
        h2 {
            font-size: 1.8em;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 184, 0, 0.15);
            padding-bottom: 10px;
        }
        h3 {
            color: var(--white);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 700;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--secondary-text);
            font-size: 0.95em;
        }
        .form-control {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 17px;
            background-color: var(--input-bg);
            color: var(--white);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            outline: none; /* Remove default outline */
        }
        .form-control::placeholder {
            color: var(--secondary-text);
            opacity: 0.7;
        }
        .form-control:focus {
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(255, 184, 0, 0.3);
        }

        /* Buttons - Elevated and more prominent */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 15px 25px;
            font-size: 19px;
            font-weight: 700;
            text-align: center;
            text-decoration: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            border: none;
            margin-top: 15px;
            box-shadow: 0 4px 10px var(--shadow-light);
            letter-spacing: 0.5px;
        }
        .btn-primary {
            background: linear-gradient(45deg, #ffc107, #ffa000);
            color: var(--primary-dark);
        }
        .btn-primary:hover {
            background: linear-gradient(45deg, #ffa000, #ffc107);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow-strong);
        }
        .btn-secondary {
            background-color: var(--secondary-text);
            color: var(--primary-dark);
        }
        .btn-secondary:hover {
            background-color: #8c9ba7;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-light);
        }
        .btn-success {
            background: linear-gradient(45deg, #04b34b, #038a3a);
            color: var(--white);
        }
        .btn-success:hover {
            background: linear-gradient(45deg, #038a3a, #04b34b);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow-strong);
        }
        .btn-danger {
            background: linear-gradient(45deg, #e53e3e, #c03030);
            color: var(--white);
        }
        .btn-danger:hover {
            background: linear-gradient(45deg, #c03030, #e53e3e);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow-strong);
        }
        .btn-info {
            background: linear-gradient(45deg, #3182ce, #2a69ac);
            color: var(--white);
        }
        .btn-info:hover {
            background: linear-gradient(45deg, #2a69ac, #3182ce);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow-strong);
        }
        .btn-outline {
            background-color: transparent;
            color: var(--primary-accent);
            border: 2px solid var(--primary-accent);
            margin-top: 25px;
            box-shadow: none; /* No shadow for outline */
        }
        .btn-outline:hover {
            background-color: var(--primary-accent);
            color: var(--primary-dark);
            box-shadow: 0 4px 10px rgba(255, 184, 0, 0.3);
            transform: translateY(-2px);
        }

        /* Messages */
        .message {
            padding: 15px;
            margin-top: 20px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            font-size: 0.95em;
            opacity: 0.9;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .message.error { background-color: #fed7d7; color: var(--danger-strong); border: 1px solid var(--danger-strong); }
        .message.success { background-color: #c6f6d5; color: var(--success-strong); border: 1px solid var(--success-strong); }
        .message.info { background-color: #bee3f8; color: var(--info-strong); border: 1px solid var(--info-strong); }

        /* Tab Navigation - Modern and slick */
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 12px;
            background-color: var(--primary-dark);
            padding: 10px;
            border-radius: 12px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }
        .tab-btn {
            background-color: transparent;
            color: var(--secondary-text);
            border: none;
            padding: 12px 22px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            flex-grow: 1; /* Allow buttons to expand */
            text-align: center;
        }
        .tab-btn.active {
            background: var(--primary-accent);
            color: var(--primary-dark);
            box-shadow: 0 3px 10px rgba(255, 184, 0, 0.4);
            transform: translateY(-2px);
            font-weight: 700;
        }
        .tab-btn:hover:not(.active) {
            background-color: #3b424f;
            color: var(--primary-accent);
            transform: translateY(-1px);
        }
        .tab-content {
            display: none;
            padding: 0; /* Remove padding here, cards inside will have it */
            width: 100%;
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-out; /* Fade in animation */
        }
        .tab-content.active {
            display: block;
        }

        /* Card sections for better clarity */
        .form-section, .info-card {
            background-color: var(--predictor-card-bg); /* Use a consistent dark card background */
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--predictor-border);
            margin-top: 25px;
            width: 100%;
            box-sizing: border-box;
            box-shadow: 0 5px 15px var(--shadow-light);
        }
        .info-card {
            text-align: center;
        }
        .info-card p {
            margin: 10px 0;
        }

        /* Wallet Section - Prominent Balance */
        .wallet-card {
            background: linear-gradient(135deg, #3182ce, #63b3ed); /* Blue gradient for wallet */
            color: var(--white);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            transition: transform 0.3s ease;
        }
        .wallet-card:hover {
            transform: translateY(-5px);
        }
        .wallet-card h3 {
            color: var(--white);
            margin-bottom: 12px;
            font-size: 1.5em;
            text-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .wallet-card p {
            font-size: 1.1em;
            margin: 8px 0;
            opacity: 0.9;
        }
        .wallet-balance {
            font-size: 3.5em;
            font-weight: 800;
            margin-top: 15px;
            text-shadow: 0 0 10px rgba(0,0,0,0.5);
            letter-spacing: 2px;
            color: var(--primary-accent); /* Make balance stand out with gold */
        }
        .user-id-display {
            font-size: 0.95em;
            opacity: 0.7;
            margin-top: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 20px;
            margin-top: 25px;
            width: 100%;
            justify-content: center;
        }
        .action-buttons button {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.2em;
            border-radius: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Deposit Image Section */
        #deposit-instructions {
            display: none;
            text-align: center;
            background-color: var(--predictor-card-bg);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--predictor-border);
            box-shadow: 0 5px 15px var(--shadow-light);
        }
        #deposit-instructions img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            margin-bottom: 25px;
            border: 2px solid var(--primary-accent);
        }
        #deposit-instructions p {
            font-size: 1.05em;
            color: var(--secondary-text);
            margin-bottom: 20px;
            line-height: 1.6;
        }
        #deposit-instructions .btn {
            margin-top: 20px;
        }

        /* History Tables - Enhanced readability */
        .history-table {
            width: 100%;
            border-collapse: separate; /* Allows border-radius */
            border-spacing: 0;
            margin-top: 25px;
            font-size: 0.95em;
            border-radius: 12px;
            overflow: hidden; /* Ensures content respects border-radius */
            box-shadow: 0 5px 15px var(--shadow-light);
        }
        .history-table th, .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .history-table th {
            background-color: var(--primary-dark);
            color: var(--primary-accent);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .history-table td {
            background-color: var(--card-bg);
            color: var(--white);
        }
        .history-table tr:nth-child(even) td {
            background-color: #3b424f; /* Slightly different background for alternating rows */
        }
        .history-table tr:hover td {
            background-color: #4a5568;
            transition: background-color 0.2s ease;
        }
        .history-table tr:last-child td {
            border-bottom: none; /* No border for the last row */
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--primary-dark); /* Dark text on bright badge */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .status-Pending { background-color: var(--warning-strong); }
        .status-Approved { background-color: var(--success-strong); }
        .status-Rejected { background-color: var(--danger-strong); }
        .status-Success { background-color: var(--success-strong); } /* For gift codes */

        .empty-history-message {
            text-align: center;
            color: var(--secondary-text);
            padding: 25px;
            font-style: italic;
            background-color: var(--card-bg);
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 2px 10px var(--shadow-light);
        }

        /* Navigation Bar (Fixed at bottom) - Elite appearance */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, #1f2733, #0a0e14); /* Dark gradient for nav */
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            z-index: 100;
            border-top: 2px solid var(--primary-accent);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-text);
            text-decoration: none;
            font-size: 0.85em;
            padding: 8px 0;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
            flex: 1; /* Distribute space evenly */
            margin: 0 5px; /* Small gap between items */
            font-weight: 600;
        }
        .nav-item i {
            font-size: 1.6em;
            margin-bottom: 6px;
            color: var(--secondary-text);
            transition: color 0.2s ease;
        }
        .nav-item.active {
            background-color: rgba(255, 184, 0, 0.2); /* Accent highlight */
            color: var(--primary-accent);
        }
        .nav-item.active i {
            color: var(--primary-accent);
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
            color: var(--white);
        }
        .nav-item:hover i {
            color: var(--white);
        }

        .logout-btn {
            position: fixed; /* Use fixed for proper positioning regardless of scroll */
            top: 20px;
            right: 20px;
            background-color: var(--danger-strong);
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            z-index: 101;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        .logout-btn:hover {
            background-color: #c03030;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.3);
        }

        /* Predictor Game Styles - The core "arrogant" section */
        #predictor-tab-content {
            background: var(--predictor-bg);
            color: var(--predictor-text);
            padding: 30px;
            border-radius: 15px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.7), 0 10px 30px var(--shadow-strong);
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            border: 2px solid var(--primary-accent); /* Strong border */
        }
        #predictor-tab-content h2 {
            color: var(--primary-accent);
            margin-bottom: 30px;
            border-bottom-color: rgba(255, 184, 0, 0.4);
            font-size: 2.5em;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 184, 0, 0.6);
        }
        .game-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-bottom: 30px;
            background-color: var(--predictor-card-bg);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid var(--predictor-border);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.4);
        }
        .game-info div {
            flex: 1;
            text-align: center;
        }
        .game-info label {
            display: block;
            font-size: 1em;
            color: var(--secondary-text);
            margin-bottom: 8px;
            font-weight: 600;
        }
        .game-info span {
            font-size: 2.2em;
            font-weight: 800;
            color: var(--primary-accent);
            letter-spacing: 2px;
            text-shadow: 0 0 8px rgba(255, 184, 0, 0.5);
        }
        #current-period, #current-timer {
            font-family: 'Share Tech Mono', monospace;
            background-color: #1a1f26; /* Darker background for numbers */
            padding: 10px 15px;
            border-radius: 8px;
            display: inline-block;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
            min-width: 120px;
        }
        
        .predictor-last-result {
            margin-top: 30px;
            padding: 25px;
            background-color: var(--predictor-card-bg);
            border-radius: 15px;
            border: 1px solid var(--predictor-border);
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5), 0 5px 15px rgba(0,0,0,0.4);
        }
        .predictor-last-result p {
            margin: 0;
            font-size: 1.2em;
            color: var(--secondary-text);
            font-weight: 600;
        }
        .predictor-last-result span {
            font-weight: 800;
            font-size: 3em; /* Much larger */
            letter-spacing: 3px;
            margin-top: 10px;
            display: block;
            filter: var(--result-glow); /* Apply glow */
            text-transform: uppercase;
        }
        .result-big { color: var(--big-color); }
        .result-small { color: var(--small-color); }

        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            h2 { font-size: 1.6em; }
            .btn { font-size: 17px; padding: 13px 20px; }
            .form-control { font-size: 15px; padding: 10px; }
            .wallet-balance { font-size: 3em; }
            .action-buttons { flex-direction: column; gap: 15px; }
            .tab-buttons { gap: 8px; padding: 8px; }
            .tab-btn { font-size: 0.95em; padding: 10px 15px; }
            .nav-item { font-size: 0.75em; }
            .nav-item i { font-size: 1.3em; }
            #predictor-tab-content h2 { font-size: 2em; }
            .game-info span { font-size: 1.8em; }
            .predictor-last-result span { font-size: 2.5em; }
            .logout-btn { top: 15px; right: 15px; padding: 8px 12px; font-size: 0.85em; }
        }

        @media (max-width: 480px) {
            body { padding-top: 15px; padding-bottom: 70px; }
            .container, #main-app-container { max-width: 100%; border-radius: 0; padding: 15px; }
            #auth-container { margin-top: 0; border-radius: 0; }
            #main-app-container { margin-top: 0; border-radius: 0; }
            .tab-buttons { border-radius: 0; flex-wrap: wrap; }
            .tab-btn { flex: 1 1 45%; margin: 0; border-radius: 6px; } /* 2 per row */
            .action-buttons { gap: 10px; }
            .bottom-nav { padding: 8px 0; }
            .nav-item { font-size: 0.7em; }
            .nav-item i { font-size: 1.2em; }
            h1 { font-size: 1.8em; margin-bottom: 20px; }
            h2 { font-size: 1.4em; margin-bottom: 20px; }
            .wallet-balance { font-size: 2.5em; }
            .predictor-last-result span { font-size: 2em; }
            .game-info span { font-size: 1.5em; }
        }
    </style>
</head>
<body>

    <div class="container" id="auth-container">
        <h1 id="auth-title">Wraith Pro Predictor Elite</h1>

        <div id="login-form">
            <div class="form-group">
                <label for="login-mobile"><i class="fas fa-mobile-alt"></i> Mobile Number (+91)</label>
                <input type="tel" id="login-mobile" class="form-control" placeholder="+91 XXXXXXXXXX" pattern="^\+91[0-9]{10}$" required>
            </div>
            <div class="form-group">
                <label for="login-password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="login-password" class="form-control" placeholder="Enter your password" required>
            </div>
            <button class="btn btn-primary" id="login-btn"><i class="fas fa-sign-in-alt"></i> Login</button>
            <div id="login-message" class="message" style="display: none;"></div>
            <button class="btn btn-outline" id="show-register-btn"><i class="fas fa-user-plus"></i> Don't have an account? Register</button>
        </div>

        <div id="register-form" style="display: none;">
            <div class="form-group">
                <label for="register-mobile"><i class="fas fa-mobile-alt"></i> Mobile Number (+91)</label>
                <input type="tel" id="register-mobile" class="form-control" placeholder="+91 XXXXXXXXXX" pattern="^\+91[0-9]{10}$" required>
            </div>
            <div class="form-group">
                <label for="register-password"><i class="fas fa-key"></i> Create Password</label>
                <input type="password" id="register-password" class="form-control" placeholder="Min 6 characters" required>
            </div>
            <div class="form-group">
                <label for="invitation-code"><i class="fas fa-user-friends"></i> Invitation Code (Optional)</label>
                <input type="text" id="invitation-code" class="form-control" placeholder="Enter invitation code">
            </div>
            <button class="btn btn-success" id="register-btn"><i class="fas fa-user-check"></i> Register Account</button>
            <div id="register-message" class="message" style="display: none;"></div>
            <button class="btn btn-outline" id="show-login-btn"><i class="fas fa-sign-in-alt"></i> Already have an account? Login</button>
        </div>
    </div>

    <div id="main-app-container">
        <button class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        <h1 id="app-title">Wraith Pro Predictor Elite</h1>

        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="wallet"><i class="fas fa-wallet"></i> Wallet</button>
            <button class="tab-btn" data-tab="deposit-history"><i class="fas fa-file-invoice-dollar"></i> Deposits</button>
            <button class="tab-btn" data-tab="withdrawal-history"><i class="fas fa-money-bill-transfer"></i> Withdrawals</button>
            <button class="tab-btn" data-tab="invite"><i class="fas fa-user-friends"></i> Invite</button>
            <button class="tab-btn" data-tab="gift-code"><i class="fas fa-gift"></i> Gift Code</button>
            <button class="tab-btn" data-tab="predictor"><i class="fas fa-dice-d6"></i> Predictor</button>
        </div>

        <div id="wallet-tab-content" class="tab-content active">
            <h2>Your Elite Wallet</h2>
            <div class="wallet-card">
                <h3>Available Balance</h3>
                <p class="wallet-balance">₹<span id="user-balance">0.00</span></p>
                <p class="user-id-display">User ID: <span id="display-user-id"></span></p>
            </div>

            <div class="action-buttons">
                <button class="deposit-btn" id="show-deposit-flow-btn">
                    <i class="fas fa-plus-circle"></i> Deposit Funds
                </button>
                <button class="withdraw-btn" id="show-withdraw-form-btn">
                    <i class="fas fa-minus-circle"></i> Withdraw Funds
                </button>
            </div>

            <div id="deposit-instructions" class="form-section">
                <h3><i class="fas fa-info-circle"></i> Deposit Instructions</h3>
                <img src="https://i.ibb.co/ym3KjfTq/IMG-20250705-221504.jpg" alt="Deposit Instructions Image">
                <p><strong>Step 1:</strong> Make payment to the UPI ID shown in the image above.</p>
                <p><strong>Step 2:</strong> After successful payment, locate your <strong>12-digit UTR / Reference Number</strong> from your payment app.</p>
                <p><strong>Step 3:</strong> Click "Proceed to Deposit Form" below and enter the exact amount and UTR number.</p>
                <button class="btn btn-primary" id="proceed-to-deposit-form-btn"><i class="fas fa-arrow-right"></i> Proceed to Deposit Form</button>
                <button class="btn btn-secondary" id="cancel-deposit-flow-btn"><i class="fas fa-times-circle"></i> Cancel</button>
            </div>

            <div id="deposit-form" class="form-section" style="display: none;">
                <h3><i class="fas fa-piggy-bank"></i> Submit Deposit Request</h3>
                <div class="form-group">
                    <label for="deposit-amount">Amount (Min ₹100)</label>
                    <input type="number" id="deposit-amount" class="form-control" placeholder="Enter amount" min="100" required>
                </div>
                <div class="form-group">
                    <label for="deposit-utr">12-Digit UTR Number</label>
                    <input type="text" id="deposit-utr" class="form-control" placeholder="Enter 12-digit UTR/Ref No." maxlength="12" minlength="12" required>
                </div>
                <button class="btn btn-success" id="submit-deposit-btn"><i class="fas fa-paper-plane"></i> Submit Deposit</button>
                <div id="deposit-message" class="message" style="display: none;"></div>
            </div>

            <div id="withdraw-form" class="form-section" style="display: none;">
                <h3><i class="fas fa-money-check-alt"></i> Request Withdrawal</h3>
                <div class="form-group">
                    <label for="withdraw-amount">Amount (Min ₹100)</label>
                    <input type="number" id="withdraw-amount" class="form-control" placeholder="Enter amount" min="100" required>
                </div>
                <div class="form-group">
                    <label for="withdraw-upi-id">Your UPI ID</label>
                    <input type="text" id="withdraw-upi-id" class="form-control" placeholder="e.g., yourname@bankupi" required>
                </div>
                <button class="btn btn-danger" id="submit-withdraw-btn"><i class="fas fa-hand-holding-usd"></i> Request Withdrawal</button>
                <div id="withdraw-message" class="message" style="display: none;"></div>
            </div>
        </div>

        <div id="gift-code-tab-content" class="tab-content">
            <h2><i class="fas fa-gift"></i> Redeem Gift Code</h2>
            <div id="gift-code-section" class="form-section">
                <div class="form-group">
                    <label for="gift-code-input">Gift Code</label>
                    <input type="text" id="gift-code-input" class="form-control" placeholder="Enter your secret gift code" required>
                </div>
                <button class="btn btn-info" id="redeem-gift-code-btn"><i class="fas fa-check-circle"></i> Redeem Code Now</button>
                <div id="gift-code-message" class="message" style="display: none;"></div>
            </div>
        </div>

        <div id="deposit-history-tab-content" class="tab-content">
            <h2><i class="fas fa-history"></i> Deposit History</h2>
            <div id="deposit-history-list">
                <p class="empty-history-message">No deposit history found.</p>
            </div>
        </div>

        <div id="withdrawal-history-tab-content" class="tab-content">
            <h2><i class="fas fa-history"></i> Withdrawal History</h2>
            <div id="withdrawal-history-list">
                <p class="empty-history-message">No withdrawal history found.</p>
            </div>
        </div>

        <div id="invite-tab-content" class="tab-content">
            <h2><i class="fas fa-share-alt"></i> Invite & Earn</h2>
            <div class="info-card">
                <p>Share your unique invitation code to earn rewards when friends join Wraith Pro Predictor Elite!</p>
                <div class="form-group" style="margin-top: 25px;">
                    <label for="my-invitation-code"><i class="fas fa-code"></i> Your Unique Invitation Code:</label>
                    <input type="text" id="my-invitation-code" class="form-control" readonly>
                </div>
                <button class="btn btn-primary" id="copy-invite-code-btn"><i class="fas fa-copy"></i> Copy Code</button>
                <div id="invite-message" class="message" style="display: none;"></div>
            </div>
            <div class="info-card" style="margin-top: 25px;">
                <h3><i class="fas fa-users"></i> Users Invited By You:</h3>
                <ul id="invited-users-list" style="list-style-type: none; padding: 0;">
                    <li class="empty-history-message">No users invited yet.</li>
                </ul>
            </div>
        </div>

        <div id="predictor-tab-content" class="tab-content">
            <h2><i class="fas fa-robot"></i> Elite Auto Predictor</h2>
            <p style="font-size: 1.1em; margin-bottom: 25px; color: var(--secondary-text); font-weight: 600;">
                Observe the next predicted outcome. The future is unveiled.
            </p>
            <div class="game-info">
                <div>
                    <label>CURRENT PERIOD:</label>
                    <span id="current-period">INITIATING...</span>
                </div>
                <div>
                    <label>TIME TO RESULT:</label>
                    <span id="current-timer">00 : 00</span>
                </div>
            </div>

            <div id="prediction-message" class="message" style="display: none;"></div>

            <div class="predictor-last-result">
                <p>LAST PREDICTION:</p>
                <span id="last-result-display">AWAITING</span>
            </div>
            <p style="font-size: 0.9em; margin-top: 20px; opacity: 0.7; color: var(--secondary-text);">
                * A nominal fee of ₹1 will be deducted from your balance for each game result generated. Ensure sufficient balance for continuous insights.
            </p>
        </div>
    </div>

    <nav class="bottom-nav" id="bottom-nav" style="display: none;">
        <a href="#" class="nav-item active" data-tab="wallet">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </a>
        <a href="#" class="nav-item" data-tab="deposit-history">
            <i class="fas fa-file-invoice-dollar"></i>
            <span>Deposits</span>
        </a>
        <a href="#" class="nav-item" data-tab="withdrawal-history">
            <i class="fas fa-money-bill-transfer"></i>
            <span>Withdrawals</span>
        </a>
        <a href="#" class="nav-item" data-tab="invite">
            <i class="fas fa-user-friends"></i>
            <span>Invite</span>
        </a>
        <a href="#" class="nav-item" data-tab="gift-code">
            <i class="fas fa-gift"></i>
            <span>Gift</span>
        </a>
        <a href="#" class="nav-item" data-tab="predictor">
            <i class="fas fa-dice-d6"></i>
            <span>Predictor</span>
        </a>
    </nav>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDVVRsdTooIjNTczs0l2dtMdE8gbGmJXTQ", // REPLACE with your actual API Key
            databaseURL: "https://pay-admin-5c556-default-rtdb.firebaseio.com", // REPLACE with your actual Realtime Database URL
            projectId: "pay-admin-5c556", // REPLACE with your actual Project ID
            storageBucket: "pay-admin-5c556.firebasestorage.app", // REPLACE with your actual Storage Bucket
            appId: "1:1086066288700:android:2142462eb91bef40c57b39" // REPLACE with your actual App ID
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = app.database();

        // --- Firebase Database Paths ---
        const usersRef = database.ref('users');
        const mobileToUserRef = database.ref('mobileToUser');
        const invitationCodesRef = database.ref('invitationCodes');
        const pendingDepositsRef = database.ref('pendingDeposits');
        const pendingWithdrawalsRef = database.ref('pendingWithdrawals');
        const predictorRef = database.ref('predictor'); // New path for predictor game data
        const giftCodesRef = database.ref('giftCodes'); // New path for gift codes

        // --- Global Variables ---
        let currentUserId = null; // Stores the current logged-in user's ID
        let currentUserData = null; // Stores the current logged-in user's data
        let predictorTimerInterval; // To store the interval ID for the predictor timer
        let currentPeriodNumber; // Stores the period ID that is currently running
        let gameResultGenerating = false; // Flag to prevent multiple result generations per period

        // --- DOM Elements ---
        // Containers
        const authContainer = document.getElementById('auth-container');
        const mainAppContainer = document.getElementById('main-app-container');
        const bottomNav = document.getElementById('bottom-nav');

        // Auth Form Elements
        const authTitle = document.getElementById('auth-title');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginMobileInput = document.getElementById('login-mobile');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginMessage = document.getElementById('login-message');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const registerMobileInput = document.getElementById('register-mobile');
        const registerPasswordInput = document.getElementById('register-password');
        const invitationCodeInput = document.getElementById('invitation-code');
        const registerBtn = document.getElementById('register-btn');
        const registerMessage = document.getElementById('register-message');
        const showLoginBtn = document.getElementById('show-login-btn');

        // Main App Elements
        const logoutBtn = document.getElementById('logout-btn');
        const tabButtons = document.querySelectorAll('.tab-buttons .tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const navItems = document.querySelectorAll('.bottom-nav .nav-item');

        // Wallet Tab Elements
        const userBalanceSpan = document.getElementById('user-balance');
        const displayUserIdSpan = document.getElementById('display-user-id');
        const showDepositFlowBtn = document.getElementById('show-deposit-flow-btn'); // Renamed
        const showWithdrawFormBtn = document.getElementById('show-withdraw-form-btn');
        const depositInstructions = document.getElementById('deposit-instructions'); // New
        const proceedToDepositFormBtn = document.getElementById('proceed-to-deposit-form-btn'); // New
        const cancelDepositFlowBtn = document.getElementById('cancel-deposit-flow-btn'); // New
        const depositForm = document.getElementById('deposit-form');
        const depositAmountInput = document.getElementById('deposit-amount');
        const depositUtrInput = document.getElementById('deposit-utr');
        const submitDepositBtn = document.getElementById('submit-deposit-btn');
        const depositMessage = document.getElementById('deposit-message');
        const withdrawForm = document.getElementById('withdraw-form');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const withdrawUpiIdInput = document.getElementById('withdraw-upi-id');
        const submitWithdrawBtn = document.getElementById('submit-withdraw-btn');
        const withdrawMessage = document.getElementById('withdraw-message');

        // Gift Code Elements
        const giftCodeInput = document.getElementById('gift-code-input');
        const redeemGiftCodeBtn = document.getElementById('redeem-gift-code-btn');
        const giftCodeMessage = document.getElementById('gift-code-message');


        // History Tab Elements
        const depositHistoryList = document.getElementById('deposit-history-list');
        const withdrawalHistoryList = document.getElementById('withdrawal-history-list');

        // Invite Tab Elements
        const myInvitationCodeInput = document.getElementById('my-invitation-code');
        const copyInviteCodeBtn = document.getElementById('copy-invite-code-btn');
        const inviteMessage = document.getElementById('invite-message');
        const invitedUsersList = document.getElementById('invited-users-list');

        // Predictor Tab Elements
        const currentPeriodSpan = document.getElementById('current-period');
        const currentTimerSpan = document.getElementById('current-timer');
        const predictionMessage = document.getElementById('prediction-message');
        const lastResultDisplay = document.getElementById('last-result-display');


        // --- Utility Functions ---

        // Simple client-side password hashing (NOT SECURE for production)
        function hashPassword(password) {
            return sha256(password + 'your-secret-salt-for-demo'); // Must be the same salt as admin_panel
        }

        // Generate a unique 6-digit User ID
        async function generateUnique6DigitId() {
            let newUserId;
            let isUnique = false;
            while (!isUnique) {
                newUserId = String(Math.floor(100000 + Math.random() * 900000));
                const snapshot = await usersRef.child(newUserId).once('value');
                if (!snapshot.exists()) {
                    isUnique = true;
                }
            }
            return newUserId;
        }

        // Generate a unique 6-character alphanumeric invitation code
        async function generateInvitationCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            let isUnique = false;
            let code = '';
            while (!isUnique) {
                code = ''; // Reset for each attempt
                for (let i = 0; i < 6; i++) {
                    code += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                const snapshot = await invitationCodesRef.child(code).once('value');
                if (!snapshot.exists()) {
                    isUnique = true;
                }
            }
            return code;
        }

        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = `message ${type}`;
            element.style.display = 'block';
        }

        function hideMessage(element) {
            element.style.display = 'none';
        }

        // --- View Switching Functions ---

        function showAppContent() {
            authContainer.style.display = 'none';
            mainAppContainer.style.display = 'flex'; // Use flex for main content layout
            bottomNav.style.display = 'flex'; // Show bottom navigation
            // Load user data once app content is visible
            loadUserData(currentUserId);
            // Default to Wallet tab on login
            switchTab('wallet');
            // Start predictor timer only when app content is shown
            startPredictorTimer();
        }

        function showAuthContent() {
            authContainer.style.display = 'block';
            mainAppContainer.style.display = 'none';
            bottomNav.style.display = 'none'; // Hide bottom navigation
            currentUserId = null; // Clear current user
            currentUserData = null; // Clear user data
            sessionStorage.removeItem('currentUserId'); // Clear session storage
            loginMobileInput.value = ''; // Clear login form
            loginPasswordInput.value = '';
            hideMessage(loginMessage);
            hideMessage(registerMessage);
            loginForm.style.display = 'block'; // Show login form by default
            registerForm.style.display = 'none';
            authTitle.textContent = 'Wraith Pro Predictor Elite';
            // Stop predictor timer when logging out
            clearInterval(predictorTimerInterval);
        }

        // --- Authentication Functions ---

        async function loginUser() {
            const mobile = loginMobileInput.value.trim();
            const password = loginPasswordInput.value.trim();

            if (!mobile || !password) {
                showMessage(loginMessage, 'Please enter both mobile number and password.', 'error');
                return;
            }
            if (!mobile.match(/^\+91[0-9]{10}$/)) {
                showMessage(loginMessage, 'Mobile number must be in +91XXXXXXXXXX format.', 'error');
                return;
            }

            showMessage(loginMessage, 'Authenticating...', 'info');

            try {
                const mobileKey = mobile.replace(/^\+91/, '');
                const userMapping = await mobileToUserRef.child(mobileKey).once('value');

                if (!userMapping.exists()) {
                    showMessage(loginMessage, 'Mobile number not registered. Please register first.', 'error');
                    return;
                }

                const userId = userMapping.val();
                const userSnapshot = await usersRef.child(userId).once('value');
                const userData = userSnapshot.val();

                if (userData && hashPassword(password) === userData.password) {
                    currentUserId = userId;
                    currentUserData = userData; // Store current user data
                    sessionStorage.setItem('currentUserId', currentUserId); // Persist login
                    showMessage(loginMessage, 'Login successful! Welcome back.', 'success');
                    setTimeout(showAppContent, 500); // Delay to show success message
                } else {
                    showMessage(loginMessage, 'Invalid mobile number or password. Please try again.', 'error');
                }
            } catch (error) {
                console.error("Login error:", error);
                showMessage(loginMessage, 'An unexpected error occurred during login. Please try again later.', 'error');
            }
        }

        async function registerUser() {
            const mobile = registerMobileInput.value.trim();
            const password = registerPasswordInput.value.trim();
            const invitationCode = invitationCodeInput.value.trim();

            if (!mobile.match(/^\+91[0-9]{10}$/)) {
                showMessage(registerMessage, 'Mobile number must be in +91XXXXXXXXXX format.', 'error');
                return;
            }
            if (password.length < 6) {
                showMessage(registerMessage, 'Password must be at least 6 characters long.', 'error');
                return;
            }

            showMessage(registerMessage, 'Creating your Elite Account...', 'info');

            try {
                const mobileKey = mobile.replace(/^\+91/, '');

                // 1. Check if mobile number is already registered
                const mobileExists = await mobileToUserRef.child(mobileKey).once('value');
                if (mobileExists.exists()) {
                    showMessage(registerMessage, 'This mobile number is already registered. Please login instead.', 'error');
                    return;
                }

                let invitedByUserId = null;
                if (invitationCode) {
                    const inviteCodeSnapshot = await invitationCodesRef.child(invitationCode).once('value');
                    if (!inviteCodeSnapshot.exists() || !inviteCodeSnapshot.val().isActive) {
                        showMessage(registerMessage, 'Invalid or expired invitation code. Please check and try again.', 'error');
                        return;
                    }
                    invitedByUserId = inviteCodeSnapshot.val().ownerUserId;
                }

                // 2. Generate unique User ID and a unique Invitation Code for the new user
                const newUserId = await generateUnique6DigitId();
                const newUserInviteCode = await generateInvitationCode();
                const hashedPassword = hashPassword(password);

                // 3. Create new user entry
                const userData = {
                    mobile: mobile,
                    password: hashedPassword, // INSECURE for production!
                    balance: 0.00, // Initial balance
                    invitationCode: newUserInviteCode, // This user's own invitation code
                    invitedBy: invitedByUserId || 'None',
                    createdAt: new Date().toISOString()
                };

                await usersRef.child(newUserId).set(userData);
                await mobileToUserRef.child(mobileKey).set(newUserId); // Store mapping

                // 4. Register the new user's own invitation code
                await invitationCodesRef.child(newUserInviteCode).set({
                    ownerUserId: newUserId,
                    usedCount: 0,
                    isActive: true,
                    generatedAt: new Date().toISOString(),
                    createdBy: newUserId // User created their own code
                });

                // 5. Update invitedBy user's invitedCount if an invitation code was used
                if (invitedByUserId) {
                    await usersRef.child(invitedByUserId).child('invitedUsers').child(newUserId).set(true);
                    await invitationCodesRef.child(invitationCode).child('usedCount').transaction((currentCount) => {
                        return (currentCount || 0) + 1;
                    });
                }

                showMessage(registerMessage, 'Registration successful! You can now log in.', 'success');
                registerMobileInput.value = '';
                registerPasswordInput.value = '';
                invitationCodeInput.value = '';
                // Automatically switch to login form after successful registration
                setTimeout(() => {
                    loginForm.style.display = 'block';
                    registerForm.style.display = 'none';
                    authTitle.textContent = 'Wraith Pro Predictor Elite';
                    hideMessage(registerMessage);
                }, 1000);

            } catch (error) {
                console.error("Registration error:", error);
                showMessage(registerMessage, 'An error occurred during registration. Please check your details and try again.', 'error');
            }
        }

        // --- User Data Loading and Display ---

        function updateBalanceDisplay(balance) {
            userBalanceSpan.textContent = parseFloat(balance).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        async function loadUserData(userId) {
            if (!userId) {
                console.warn("No currentUserId to load data.");
                showAuthContent(); // Go back to login if no ID
                return;
            }

            try {
                const userSnapshot = await usersRef.child(userId).once('value');
                currentUserData = userSnapshot.val();

                if (currentUserData) {
                    displayUserIdSpan.textContent = userId;
                    updateBalanceDisplay(currentUserData.balance || 0);
                    myInvitationCodeInput.value = currentUserData.invitationCode || 'N/A';
                } else {
                    // User data not found, likely deleted by admin or invalid ID
                    console.error("User data not found for ID:", userId);
                    alert("Your session is invalid or user data is missing. Please log in again.");
                    showAuthContent();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                alert("Failed to load user data. Please check your internet connection or try again.");
                showAuthContent();
            }
        }

        function renderHistoryItem(item, type) {
            const date = new Date(item.timestamp);
            const formattedDate = date.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            const statusClass = `status-${item.status || 'Pending'}`;
            let details = '';
            if (type === 'deposit') {
                details = `UTR: ${item.utr || 'N/A'}`;
            } else if (type === 'withdrawal') {
                details = `UPI: ${item.upiId || 'N/A'}`;
            } else if (type === 'giftCode') { // New type for gift code redemption history
                details = `Code: ${item.code || 'N/A'}`;
            }


            return `
                <div class="info-card" style="background-color: #3b424f; margin-bottom: 15px; padding: 15px;">
                    <p><strong>Amount:</strong> ₹${parseFloat(item.amount || 0).toLocaleString('en-IN')}</p>
                    <p><strong>Date:</strong> ${formattedDate}</p>
                    <p><strong>Status:</strong> <span class="${statusClass} status-badge">${item.status || 'Success'}</span></p>
                    <p><strong>Details:</strong> ${details}</p>
                </div>
            `;
        }

        function renderInvitedUsers(invitedUserIds) {
            invitedUsersList.innerHTML = ''; // Clear previous list
            if (!invitedUserIds || Object.keys(invitedUserIds).length === 0) {
                invitedUsersList.innerHTML = `<li class="empty-history-message">No users invited yet.</li>`;
                return;
            }

            // Fetch details for each invited user and display
            const invitedUserPromises = Object.keys(invitedUserIds).map(async (invitedId) => {
                const userSnapshot = await usersRef.child(invitedId).once('value');
                const invitedUserData = userSnapshot.val();
                if (invitedUserData) {
                    const listItem = document.createElement('li');
                    listItem.style.marginBottom = '8px';
                    listItem.style.padding = '10px';
                    listItem.style.backgroundColor = '#2d3748';
                    listItem.style.borderRadius = '8px';
                    listItem.style.border = '1px solid #4a5568';
                    listItem.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
                    listItem.textContent = `User ID: ${invitedId} (Mobile: ${invitedUserData.mobile ? invitedUserData.mobile.replace('+91', '') : 'N/A'}) - Reg. Date: ${new Date(invitedUserData.createdAt).toLocaleDateString('en-IN')}`;
                    return listItem;
                }
                return null;
            });

            Promise.all(invitedUserPromises).then(items => {
                invitedUsersList.innerHTML = ''; // Clear again to avoid flicker if new items loaded
                if (items.filter(Boolean).length === 0) {
                     invitedUsersList.innerHTML = `<li class="empty-history-message">No users invited yet.</li>`;
                } else {
                    items.forEach(item => {
                        if (item) {
                            invitedUsersList.appendChild(item);
                        }
                    });
                }
            });
        }


        // --- Deposit/Withdrawal Forms and Logic ---

        // Renamed from showDepositFormBtn to showDepositFlowBtn
        showDepositFlowBtn.addEventListener('click', () => {
            depositInstructions.style.display = 'block'; // Show instructions first
            depositForm.style.display = 'none'; // Hide actual form
            withdrawForm.style.display = 'none'; // Hide other form
            hideMessage(depositMessage); // Clear previous messages
        });

        proceedToDepositFormBtn.addEventListener('click', () => {
            depositInstructions.style.display = 'none'; // Hide instructions
            depositForm.style.display = 'block'; // Show deposit form
            depositAmountInput.value = '';
            depositUtrInput.value = '';
            hideMessage(depositMessage);
        });

        cancelDepositFlowBtn.addEventListener('click', () => {
            depositInstructions.style.display = 'none'; // Hide instructions
            depositForm.style.display = 'none'; // Hide deposit form
            hideMessage(depositMessage);
        });

        showWithdrawFormBtn.addEventListener('click', () => {
            withdrawForm.style.display = 'block';
            depositInstructions.style.display = 'none'; // Hide deposit instructions
            depositForm.style.display = 'none'; // Hide deposit form
            hideMessage(withdrawMessage); // Clear previous messages
            withdrawAmountInput.value = '';
            withdrawUpiIdInput.value = '';
        });

        submitDepositBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                showMessage(depositMessage, 'Please log in to make a deposit.', 'error');
                return;
            }

            const amount = parseFloat(depositAmountInput.value);
            const utr = depositUtrInput.value.trim();

            if (isNaN(amount) || amount <= 0) {
                showMessage(depositMessage, 'Please enter a valid amount.', 'error');
                return;
            }
            if (utr.length !== 12 || !/^\d+$/.test(utr)) {
                showMessage(depositMessage, 'UTR Number must be a 12-digit number.', 'error');
                return;
            }

            showMessage(depositMessage, 'Submitting deposit request...', 'info');

            try {
                const depositId = database.ref().child('pendingDeposits').push().key; // Generate unique ID
                const timestamp = new Date().toISOString();

                const depositData = {
                    userId: currentUserId,
                    amount: amount,
                    utr: utr,
                    timestamp: timestamp,
                    status: 'Pending'
                };

                // Add to pendingDeposits queue for admin approval
                await pendingDepositsRef.child(depositId).set(depositData);

                // Also record in user's own history immediately
                await usersRef.child(currentUserId).child('deposits').child(depositId).set(depositData);

                showMessage(depositMessage, 'Deposit request submitted successfully! Your balance will be updated upon admin approval.', 'success');
                depositAmountInput.value = '';
                depositUtrInput.value = '';
            } catch (error) {
                console.error("Deposit request error:", error);
                showMessage(depositMessage, 'Failed to submit deposit request. Please try again.', 'error');
            }
        });

        submitWithdrawBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                showMessage(withdrawMessage, 'Please log in to make a withdrawal.', 'error');
                return;
            }

            const amount = parseFloat(withdrawAmountInput.value);
            const upiId = withdrawUpiIdInput.value.trim();

            if (isNaN(amount) || amount <= 0) {
                showMessage(withdrawMessage, 'Please enter a valid amount.', 'error');
                return;
            }
            if (!upiId) {
                showMessage(withdrawMessage, 'Please enter your UPI ID.', 'error');
                return;
            }

            showMessage(withdrawMessage, 'Processing withdrawal request...', 'info');

            try {
                // Use a transaction to safely deduct balance
                const withdrawalId = database.ref().child('pendingWithdrawals').push().key; // Generate unique ID
                const timestamp = new Date().toISOString();

                let newBalance = 0;
                const transactionResult = await usersRef.child(currentUserId).child('balance').transaction((currentBalance) => {
                    currentBalance = currentBalance || 0;
                    if (currentBalance >= amount) {
                        newBalance = currentBalance - amount;
                        return newBalance;
                    }
                    return undefined; // Abort transaction if insufficient funds
                });

                if (transactionResult.committed) {
                    const withdrawalData = {
                        userId: currentUserId,
                        amount: amount,
                        upiId: upiId,
                        timestamp: timestamp,
                        status: 'Pending'
                    };

                    // Add to pendingWithdrawals queue for admin approval
                    await pendingWithdrawalsRef.child(withdrawalId).set(withdrawalData);

                    // Also record in user's own history immediately
                    await usersRef.child(currentUserId).child('withdrawals').child(withdrawalId).set(withdrawalData);

                    showMessage(withdrawMessage, 'Withdrawal request submitted successfully! Amount deducted, pending admin approval.', 'success');
                    withdrawAmountInput.value = '';
                    withdrawUpiIdInput.value = '';
                    updateBalanceDisplay(newBalance); // Update UI immediately
                } else {
                    showMessage(withdrawMessage, 'Insufficient balance for withdrawal or transaction aborted. Please check your balance.', 'error');
                }
            } catch (error) {
                console.error("Withdrawal request error:", error);
                showMessage(withdrawMessage, 'Failed to submit withdrawal request. Please try again.', 'error');
            }
        });

        // --- Gift Code Redemption Logic ---
        redeemGiftCodeBtn.addEventListener('click', async () => {
            if (!currentUserId) {
                showMessage(giftCodeMessage, 'Please log in to redeem a gift code.', 'error');
                return;
            }

            const giftCode = giftCodeInput.value.trim();
            if (!giftCode) {
                showMessage(giftCodeMessage, 'Please enter a gift code.', 'error');
                return;
            }

            showMessage(giftCodeMessage, 'Attempting to redeem gift code...', 'info');

            try {
                const giftCodeSnapshot = await giftCodesRef.child(giftCode).once('value');

                if (!giftCodeSnapshot.exists()) {
                    showMessage(giftCodeMessage, 'Invalid gift code. Please double-check the code.', 'error');
                    return;
                }

                const codeData = giftCodeSnapshot.val();

                if (codeData.isRedeemed) {
                    showMessage(giftCodeMessage, 'This gift code has already been redeemed by another user.', 'error');
                    return;
                }

                const amount = parseFloat(codeData.amount || 0);
                if (isNaN(amount) || amount <= 0) {
                    showMessage(giftCodeMessage, 'Invalid gift code amount. Please contact support immediately.', 'error');
                    return;
                }

                // Use a transaction to update user balance and gift code status atomically
                const userBalanceRef = usersRef.child(currentUserId).child('balance');
                let newBalance = 0;

                const transactionResult = await userBalanceRef.transaction((currentBalance) => {
                    currentBalance = currentBalance || 0;
                    newBalance = currentBalance + amount;
                    return newBalance;
                });

                if (transactionResult.committed) {
                    // Update gift code status to redeemed
                    await giftCodesRef.child(giftCode).update({
                        isRedeemed: true,
                        redeemedBy: currentUserId,
                        redeemedAt: new Date().toISOString()
                    });

                    // Record in user's history as well (optional, but good for tracking)
                    await usersRef.child(currentUserId).child('giftCodeRedemptions').push({
                        code: giftCode,
                        amount: amount,
                        timestamp: new Date().toISOString(),
                        status: 'Success'
                    });

                    showMessage(giftCodeMessage, `Success! You've redeemed ₹${amount.toLocaleString('en-IN')}!`, 'success');
                    giftCodeInput.value = ''; // Clear input
                    updateBalanceDisplay(newBalance); // Update UI
                } else {
                    showMessage(giftCodeMessage, 'Failed to redeem gift code. Please try again. (Balance update issue)', 'error');
                }

            } catch (error) {
                console.error("Gift code redemption error:", error);
                showMessage(giftCodeMessage, 'An unexpected error occurred during redemption. Please ensure you have a stable connection.', 'error');
            }
        });


        // --- Predictor Game Logic (Auto-Play) ---
        function generatePeriodInfo() {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');

            // Format current time in UTC to match the Java code's Calendar.getInstance(TimeZone.getTimeZone("UTC"))
            const utcHours = now.getUTCHours();
            const utcMinutes = now.getUTCMinutes();
            const utcSeconds = now.getUTCSeconds();

            const totalMinutesUTC = utcHours * 60 + utcMinutes;
            const periodBase = `${year}${month}${day}`;
            currentPeriodNumber = `${periodBase}1000${(10001 + totalMinutesUTC)}`;

            currentPeriodSpan.textContent = currentPeriodNumber;

            const remainingSeconds = 60 - utcSeconds;
            // Format to "  x x  :  x x"
            // Ensure single digits are padded with a space or zero
            const formattedMinutes = String(Math.floor(remainingSeconds / 60)).padStart(2, '0');
            const formattedSeconds = String(remainingSeconds % 60).padStart(2, '0');

            currentTimerSpan.textContent = `${formattedMinutes} : ${formattedSeconds}`;

            // Trigger result generation at the start of a new period (when remainingSeconds is 60 or 0, indicating a minute transition)
            if (utcSeconds === 0 && !gameResultGenerating) { // Check for new minute (utcSeconds is 0) and prevent multiple calls
                 gameResultGenerating = true; // Set flag
                 // Small delay to ensure all UI updates are processed before deduction/result
                 setTimeout(async () => {
                     await processAutoResult();
                     gameResultGenerating = false; // Reset flag after result
                 }, 500); // 0.5 second delay
            }
        }

        async function processAutoResult() {
            if (!currentUserId || !currentUserData) {
                console.warn("User not logged in, skipping auto-predictor result processing.");
                showMessage(predictionMessage, 'Please log in to participate in Predictor.', 'info');
                return;
            }

            // Fetch current balance to ensure it's up-to-date for the transaction
            const userSnapshot = await usersRef.child(currentUserId).once('value');
            currentUserData = userSnapshot.val(); // Update local data

            if (currentUserData.balance < 1) {
                showMessage(predictionMessage, 'Insufficient balance (minimum ₹1 required) to continue auto-play. Please deposit funds.', 'error');
                lastResultDisplay.textContent = 'AWAITING';
                lastResultDisplay.className = '';
                return;
            }

            const previousPeriod = currentPeriodNumber; // The period that just ended
            const result = Math.random() < 0.5 ? 'BIG' : 'SMALL'; // Randomly choose Big or Small for demo

            try {
                // Deduct 1 Rupee from user's balance
                let newBalance = 0;
                const transactionResult = await usersRef.child(currentUserId).child('balance').transaction((currentBalance) => {
                    currentBalance = currentBalance || 0;
                    if (currentBalance >= 1) {
                        newBalance = currentBalance - 1;
                        return newBalance;
                    }
                    return undefined; // Abort transaction if insufficient funds
                });

                if (transactionResult.committed) {
                    // Update last result display
                    lastResultDisplay.textContent = result;
                    lastResultDisplay.className = result === 'BIG' ? 'result-big' : 'result-small';

                    showMessage(predictionMessage, `Period ${previousPeriod}: The elite prediction is ${result}! ₹1 fee applied.`, 'success');
                    // Store the result in Firebase for history/admin
                    await predictorRef.child('lastResult').set({
                        period: previousPeriod,
                        result: result,
                        timestamp: new Date().toISOString()
                    });
                    // You could also store specific user play data here if needed,
                    // e.g., usersRef.child(currentUserId).child('predictorHistory').child(previousPeriod).set({ result: result, deducted: 1, timestamp: new Date().toISOString() });

                    // Update UI balance immediately
                    updateBalanceDisplay(newBalance);
                } else {
                    // This block should ideally not be reached if the initial balance check is correct
                    showMessage(predictionMessage, 'Failed to deduct balance for prediction. Insufficient funds or transaction error.', 'error');
                }
            } catch (error) {
                console.error("Error processing auto-predictor result:", error);
                showMessage(predictionMessage, 'An error occurred during auto-prediction. Please try again.', 'error');
            }
        }


        function startPredictorTimer() {
            if (predictorTimerInterval) {
                clearInterval(predictorTimerInterval); // Clear any existing timer
            }
            generatePeriodInfo(); // Call once immediately to set initial state
            predictorTimerInterval = setInterval(generatePeriodInfo, 1000); // Update every second
        }

        // --- Event Listeners ---

        // Authentication form toggles
        showRegisterBtn.addEventListener('click', () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            authTitle.textContent = 'Register for Wraith Pro Predictor Elite';
            hideMessage(loginMessage);
            hideMessage(registerMessage);
        });

        showLoginBtn.addEventListener('click', () => {
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
            authTitle.textContent = 'Wraith Pro Predictor Elite';
            hideMessage(loginMessage);
            hideMessage(registerMessage);
        });

        loginBtn.addEventListener('click', loginUser);
        registerBtn.addEventListener('click', registerUser);

        // Logout button
        logoutBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to log out from Wraith Pro Predictor Elite?')) {
                showAuthContent();
            }
        });

        // Tab navigation for main app content
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                switchTab(tab);
            });
        });

        navItems.forEach(navItem => {
            navItem.addEventListener('click', (e) => {
                e.preventDefault(); // Prevent default link behavior
                const tab = navItem.dataset.tab;
                switchTab(tab);
            });
        });


        // Function to handle tab switching
        async function switchTab(tabName) {
            // Remove active class from all buttons and nav items
            tabButtons.forEach(btn => btn.classList.remove('active'));
            navItems.forEach(item => item.classList.remove('active'));

            // Hide all tab contents
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked button and nav item
            document.querySelector(`.tab-buttons .tab-btn[data-tab="${tabName}"]`).classList.add('active');
            document.querySelector(`.bottom-nav .nav-item[data-tab="${tabName}"]`).classList.add('active');

            // Show the target tab content
            document.getElementById(`${tabName}-tab-content`).classList.add('active');

            // Specific actions for each tab
            if (tabName === 'wallet') {
                // Re-load balance to ensure it's fresh
                if (currentUserId) {
                    const balanceSnapshot = await usersRef.child(currentUserId).child('balance').once('value');
                    updateBalanceDisplay(balanceSnapshot.val() || 0);
                }
                // Hide forms when switching back to wallet main view
                depositInstructions.style.display = 'none'; // Hide instructions
                depositForm.style.display = 'none'; // Hide deposit form
                withdrawForm.style.display = 'none';
                hideMessage(depositMessage);
                hideMessage(withdrawMessage);
            } else if (tabName === 'deposit-history') {
                if (currentUserId) {
                    const depositsSnapshot = await usersRef.child(currentUserId).child('deposits').once('value');
                    const deposits = depositsSnapshot.val();
                    depositHistoryList.innerHTML = '';
                    if (deposits) {
                        // Convert object to array, sort by timestamp, and reverse for newest first
                        const sortedDeposits = Object.values(deposits).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        sortedDeposits.forEach(item => {
                            depositHistoryList.innerHTML += renderHistoryItem(item, 'deposit');
                        });
                    } else {
                        depositHistoryList.innerHTML = '<p class="empty-history-message">No deposit history found. Initiate your first deposit!</p>';
                    }
                }
            } else if (tabName === 'withdrawal-history') {
                if (currentUserId) {
                    const withdrawalsSnapshot = await usersRef.child(currentUserId).child('withdrawals').once('value');
                    const withdrawals = withdrawalsSnapshot.val();
                    withdrawalHistoryList.innerHTML = '';
                    if (withdrawals) {
                        const sortedWithdrawals = Object.values(withdrawals).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                        sortedWithdrawals.forEach(item => {
                            withdrawalHistoryList.innerHTML += renderHistoryItem(item, 'withdrawal');
                        });
                    } else {
                        withdrawalHistoryList.innerHTML = '<p class="empty-history-message">No withdrawal history found. Request a withdrawal to see it here.</p>';
                    }
                }
            } else if (tabName === 'gift-code') {
                giftCodeInput.value = '';
                hideMessage(giftCodeMessage);
            }
            else if (tabName === 'invite') {
                if (currentUserId && currentUserData) {
                    myInvitationCodeInput.value = currentUserData.invitationCode || 'N/A';
                    renderInvitedUsers(currentUserData.invitedUsers); // Load invited users
                }
            } else if (tabName === 'predictor') {
                startPredictorTimer(); // Ensure timer is running
                // You might want to fetch and display the very last result from Firebase here
                predictorRef.child('lastResult').once('value').then(snapshot => {
                    const lastRes = snapshot.val();
                    if (lastRes) {
                        lastResultDisplay.textContent = lastRes.result;
                        lastResultDisplay.className = lastRes.result === 'BIG' ? 'result-big' : 'result-small';
                    } else {
                        lastResultDisplay.textContent = 'AWAITING';
                        lastResultDisplay.className = '';
                    }
                });
            }
        }

        // Copy Invitation Code
        copyInviteCodeBtn.addEventListener('click', () => {
            myInvitationCodeInput.select();
            myInvitationCodeInput.setSelectionRange(0, 99999); // For mobile devices
            document.execCommand("copy");
            showMessage(inviteMessage, 'Invitation code copied to clipboard! Share the elite experience.', 'success');
            setTimeout(() => hideMessage(inviteMessage), 2000);
        });

        // --- Firebase Listeners for Real-time Updates ---
        // Listen to balance changes for the current user
        usersRef.on('child_changed', (snapshot) => {
            if (currentUserId && snapshot.key === currentUserId) {
                const updatedData = snapshot.val();
                if (updatedData) {
                    currentUserData = updatedData; // Update local copy of user data
                    if (updatedData.balance !== undefined) {
                        updateBalanceDisplay(updatedData.balance);
                    }
                    // Also re-render history if active, to pick up status changes
                    const activeTabElement = document.querySelector('.tab-content.active');
                    if (activeTabElement) {
                        const activeTabName = activeTabElement.id.replace('-tab-content', '');
                        if (activeTabName === 'deposit-history' || activeTabName === 'withdrawal-history' || activeTabName === 'invite') {
                             switchTab(activeTabName); // Re-load history/invited users to update statuses
                        }
                    }
                }
            }
        });

        // Listen for updates to the last result in the predictor
        predictorRef.child('lastResult').on('value', (snapshot) => {
            const lastRes = snapshot.val();
            if (lastRes) {
                lastResultDisplay.textContent = lastRes.result;
                lastResultDisplay.className = lastRes.result === 'BIG' ? 'result-big' : 'result-small';
                // Show a temporary message about the new result
                showMessage(predictionMessage, `New Prediction for Period ${lastRes.period}: ${lastRes.result}!`, 'info');
                setTimeout(() => hideMessage(predictionMessage), 3000);
            }
        });


        // Initial check on page load
        document.addEventListener('DOMContentLoaded', () => {
            currentUserId = sessionStorage.getItem('currentUserId');
            if (currentUserId) {
                // If a userId is found in sessionStorage, attempt to load user data and show app content
                showAppContent();
            } else {
                // No userId found, show login/register forms
                showAuthContent();
            }
        });

    </script>
</body>
</html>
